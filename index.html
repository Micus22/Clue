<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Paradox: A Reality Unravels</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        /* DOS-like styling */
        :root {
            --color-neon-green: #0F0;
            --color-neon-pink: #F0F; /* Neon Pink */
            --color-neon-yellow: #FF0; /* Neon Yellow */
            --color-dark-green: #090;
            --color-black: #000;
        }

        body {
            background-color: var(--color-black); /* Black background */
            color: var(--color-neon-green); /* Green text */
            font-family: 'Courier New', Courier, monospace; /* Monospace font */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            overflow: hidden; /* Prevent body scroll */
        }

        .game-container {
            width: 100%;
            max-width: 800px; /* Max width for game area */
            border: 2px solid var(--color-neon-pink); /* Neon Pink border */
            padding: 1rem;
            display: flex;
            flex-direction: column;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5); /* Neon Pink glow */
            height: 95vh; /* Occupy most of the viewport height */
            max-height: 900px; /* Cap max height for very large screens */
        }

        .game-output {
            background-color: var(--color-black);
            border: 1px dashed var(--color-dark-green); /* Dashed green border for output */
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1; /* Allow output to grow and fill available space */
            margin-bottom: 1rem;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word; /* Break long words */
            border-radius: 4px; /* Slightly rounded corners for inner element */
            line-height: 1.4; /* Improve readability for monospace font */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .input-area {
            display: flex;
            align-items: center;
            flex-shrink: 0; /* Prevent input area from shrinking */
        }

        .prompt {
            color: var(--color-neon-green);
            margin-right: 0.5rem;
        }

        .command-input {
            background-color: var(--color-black);
            color: var(--color-neon-green);
            border: 1px solid var(--color-neon-green);
            padding: 0.5rem;
            flex-grow: 1;
            font-family: 'Courier New', Courier, monospace;
            outline: none; /* Remove default focus outline */
            border-radius: 4px; /* Rounded corners */
        }

        .command-input:focus {
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.7); /* Green glow on focus */
        }

        .game-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            gap: 0.5rem; /* Space between buttons */
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }

        .game-button {
            background-color: var(--color-black);
            color: var(--color-neon-green);
            border: 1px solid var(--color-neon-green);
            padding: 0.5rem 1rem;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s, border-color 0.2s;
            flex-grow: 1; /* Allow buttons to grow */
            min-width: 120px; /* Minimum width for buttons */
        }

        .game-button:hover {
            background-color: var(--color-neon-yellow); /* Yellow on hover */
            color: var(--color-black);
            border-color: var(--color-neon-yellow);
            box-shadow: 0 0 8px rgba(255, 255, 0, 0.7); /* Yellow glow on hover */
        }

        /* Message box styling */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s linear;
        }

        .message-box-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .message-box {
            background-color: var(--color-black);
            border: 2px solid var(--color-neon-yellow); /* Neon Yellow border */
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.7); /* Neon Yellow glow */
            text-align: center;
            font-family: 'Courier New', Courier, monospace;
            color: var(--color-neon-green);
            max-width: 500px;
            width: 90%;
        }

        .message-box h2 {
            margin-top: 0;
            color: var(--color-neon-pink); /* Neon Pink for title */
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .message-box p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.5;
            white-space: pre-wrap; /* Ensure poem and ASCII art render correctly */
        }

        .message-box button {
            background-color: var(--color-neon-green);
            color: var(--color-black);
            border: none;
            padding: 0.8rem 1.5rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
        }

        .message-box button:hover {
            background-color: var(--color-neon-pink); /* Neon Pink on hover */
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.7); /* Neon Pink glow */
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="game-output" class="game-output"></div>
        <div class="input-area">
            <span class="prompt">></span><input type="text" id="command-input" class="command-input" autofocus>
        </div>
        <div class="game-buttons">
            <button class="game-button" onclick="handleButtonClick('look')">LOOK</button>
            <button class="game-button" onclick="handleButtonClick('examine')">EXAMINE</button>
            <button class="game-button" onclick="handleButtonClick('go')">GO</button>
            <button class="game-button" onclick="handleButtonClick('inventory')">INVENTORY</button>
            <button class="game-button" onclick="handleButtonClick('accuse')">ACCUSE</button>
            <button class="game-button" onclick="handleButtonClick('help')">HELP</button>
            <button class="game-button" onclick="handleButtonClick('restart')">RESTART</button>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box-overlay" class="message-box-overlay">
        <div class="message-box">
            <h2 id="message-box-title"></h2>
            <p id="message-box-content"></p>
            <button id="message-box-button" onclick="hideMessageBox()">OK</button>
        </div>
    </div>

    <script>
        // Game Configuration
        const gameConfig = {
            suspects: [
                "The Grand Designer", "The Cosmic Constant", "The Probabilistic Wave",
                "The Multiverse Architect", "The Unified Field Theory"
            ],
            weapons: [
                "Quantum Entanglement", "Wave-Particle Duality", "Dark Energy Flux",
                "String Vibration Resonance", "Singularity Collapse"
            ],
            origins: [
                "The Zero-Point Field", "The Primordial Atom", "The Quantum Foam",
                "The Brane Collision", "The Multiverse Nexus"
            ],
            locations: {
                "The Ancient Library": {
                    description: "Dusty tomes on cosmological theories fill the shelves. A strange aura emanates from a central podium.",
                    examinables: [
                        { name: "podium", description: "A central podium carved from a meteorite. It feels warm to the touch. Scratches on its surface seem to trace ancient, forgotten constellations, hinting at celestial alignments that predate known cosmic eras.",
                          asciiArt: `
     .::.
   _.'||'._
  /  o  o  \\
 | --====-- |
 \\__________/`
                        },
                        { name: "scrolls", description: "Ancient scrolls detailing forgotten quantum rituals. Their brittle papyrus crackles as you carefully unroll one, revealing faded diagrams of cosmic events and equations that seem to predate even the concept of mathematics.",
                          asciiArt: `
  _.-._
 / | | \\
|  | |  |
|.-'-'.-|
 \`-----'`
                        },
                        { name: "the great book of knowledge", description: "A massive, ancient tome bound in cosmic leather, pulsing with faint energy. You can 'READ' it.", specialAction: "readGreatBook",
                          asciiArt: `
  .--.
 / _  \\
| (_) |
|  _  |
| (_) |
 \`--'`
                        }
                    ]
                },
                "The Observatory's Dome": {
                    description: "Powerful telescopes point skyward, gathering faint whispers from distant galaxies. A complex star chart lies on a desk.",
                    examinables: [
                        { name: "star chart", description: "A shimmering star chart, seemingly mapping realities beyond our own. Runes etched into its surface pulsate faintly, depicting gravitational anomalies that defy known physics and stellar nurseries forming in impossibly complex geometries.",
                          asciiArt: `
  .--*--.
 / *.-.* \\
| *-+-* |
 \\ *'-'* /
  '--*--' `
                        },
                        { name: "telescope", description: "A massive telescope, its lens humming with residual cosmic energy. You can also try 'EXAMINE LENS' for a deeper view.",
                          asciiArt: `
         __
 _.----'\`|| \`.                _..
]_       ||   \`.         _..--\\  \\
  \`\`\`\`\`\`\`--.    \`._ ..--'    \`|  |
         /\\ \`.    \\ \\         |  |
         ||   \`.   \\ \\        |  |
        /  \\    \`. | |        | .|
       //\/\\\\     \`/_/......._/  /
      /. || \\\\                \`-'
     //  ||  \`\\
    //   ||   \\\\
   /.    ||    .\ 
  //     ||    ||
 ||      ||`
                        },
                        { name: "lens", description: "The primary lens of the telescope. When you look through it...", specialAction: "gazeThroughLens",
                          asciiArt: `
  .--.--.
 /  o  o  \\
|  .--.--.  |
 \\'  o  o  '/
  \`--'--'`
                        }
                    ]
                },
                "The Quantum Laboratory": {
                    description: "Strange apparatus hums and whirs, manipulating particles at unseen scales. A flickering holographic display dominates the room.",
                    examinables: [
                        { name: "display", description: "A holographic display flickers, showing complex wave function collapse simulations. The projections shift between coherent waves and definite particles, revealing the intricate dance of probability and observation that dictates the very fabric of existence.",
                          asciiArt: `
 .-------------.
|  __   __   __|
| |  | |  | |  |
| |__| |__| |__|
|  --   --   -- |
\`-------------`
                        },
                        { name: "hadron collider", description: "A colossal ring of superconducting magnets designed to accelerate particles to near light-speed, smashing them together to reveal fundamental forces. Residual energy crackles around its massive coils, hinting at the immense power contained within and the hidden symmetries of reality it seeks to unveil.",
                          asciiArt: `
       _.-'-._
     .'  _ _  '.
    /  .'   '.  \\
   |  |       |  |
   |  |_______|  |
    \\  '. _ .'  /
     '. _'-'_ .'
       \`---`
                        },
                        { name: "quantum computer", description: "A complex array of shimmering qubits, constantly calculating probabilistic outcomes. It hums with a faint, otherworldly melody.", specialAction: "interactWithQuantumComputer",
                          asciiArt: `
   _______
  /       \\
 |  _.-._  |
 | ( o o ) |
 |  \`-'-'  |
  \\_______/
   |     |
   |=====|
   \`-----'`
                        }
                    ]
                },
                "The Forgotten Anomaly": {
                    description: "A tear in space-time, pulsating with raw, untamed energy. An old, forgotten logbook floats nearby.",
                    examinables: [
                        { name: "logbook", description: "An ancient, water-damaged logbook containing cryptic entries. The ink blurs in places, but you discern references to temporal distortions and paradoxical events, scribbled frantically as if the author was witnessing reality itself fraying at the edges, detailing experiments that tinkered with causality.",
                          asciiArt: `
 .-----------.
|  _.-._    |
| /.-.-.\\   |
| \`-----'/  |
 \`-----------`
                        },
                        { name: "anomaly", description: "The anomaly itself, a vortex of pure, unstable reality. Staring into its depths makes your mind swim, as if the fundamental laws of existence are being rewritten before your very eyes. You feel a strange pull, a subtle unraveling of something infinitely complex, almost as if reality is questioning its own definition.",
                          asciiArt: `
    _.-^-._
   /       \\
  |  * * |
  |    o    |
  \\_._._._./`
                        },
                        { name: "pop-tart kitty", description: "A small, feline creature, shimmering with an ethereal glow and smelling faintly of fruit pastry. It gazes at you with knowing eyes.", specialAction: "interactWithPopTartKitty",
                          asciiArt: `
     /\\_/\\
    ( o.o )
    > ^ <
   /  -  \\
  (_______)
   "POP!"
          "TART!"
                "MEOW!"`
                        }
                    ]
                },
                "The Cosmic Antechamber": {
                    description: "Beyond the known universe, a space of pure thought and theoretical constructs. A shimmering portal offers a view.",
                    examinables: [
                        { name: "portal", description: "A shimmering portal, offering glimpses of infinite possibilities. Beyond its shimmering veil, you sense echoes of realities where fundamental constants might differ, where creation unfolded in myriad alternative ways, each a unique cosmic tapestry.",
                          asciiArt: `
  .--.--.
 /  .-.  \\
|  /   \\  |
|  \\   /  |
 \\  \`-'  /
  \`--'--'`
                        },
                        { name: "altar", description: "A smooth, obsidian altar, resonating with a faint, low hum. Intricate patterns of what seem to be subatomic particles are etched into its surface, suggesting it was used in profound acts of cosmic manipulation or perhaps as a nexus for universal energies.",
                          asciiArt: `
     /\\
    /__\\
   |____|
  /______\\
 /________\\`
                        },
                        { name: "black hole roller coaster", description: "A strange, sleek conveyance that seems to twist into an impossibly small point, promising a ride through the fabric of existence itself.", specialAction: "rideBlackHoleRollerCoaster",
                          asciiArt: `
      .--.
     /    \\
    |      |
    |      |
     \\    /
      \`--'
    _ _ _ _ _ _ _ _ _ _ _ _ _
   /                         \\
  |  [ ]-o-[ ]-o-[ ]-o-[ ]  |
  \\_ _ _ _ _ _ _ _ _ _ _ _ _/`
                        }
                    ]
                }
            },
            eventData: {
                gravityEvents: [
                    {
                        title: "GRAVITATIONAL FLUCTUATION DETECTED!",
                        description: "A ripple in the spacetime fabric appears, causing objects around you to briefly float. The universe whispers its fundamental laws.",
                        clue: "Gravity Event: Gravitational fields are distortions in spacetime, influenced by mass-energy distribution."
                    },
                    {
                        title: "NEWTONIAN ECHO",
                        description: "A ghostly projection of Sir Isaac Newton materializes, contemplating a falling apple. He turns to you, a profound wisdom in his eyes.",
                        dialogue: `NEWTON: "For every action, there is an equal and opposite reaction. Even the grand creation of reality must adhere to such principles."`,
                        clue: "Gravity Event: Action-reaction principles apply even at cosmic scales of creation."
                    },
                    {
                        title: "COSMIC LENSING PHENOMENON",
                        description: "Distant galaxies appear warped and stretched, their light bent by an unseen gravitational mass. A natural cosmic magnifying glass.",
                        clue: "Gravity Event: Mass warps spacetime, bending light and revealing hidden structures of reality."
                    }
                ],
                quirkEvents: [
                    {
                        name: "Superposition Quirk",
                        poem: `I am the state, both here and there,
                               A wave of chances, beyond compare.
                               Until observed, my truth concealed,
                               In quantum dance, I am revealed.`,
                        clue: "Quirk Clue: Reality's true state remains undefined until observed or interacted with."
                    },
                    {
                        name: "Entanglement Quirk",
                        poem: `Though miles apart, our fates are spun,
                               A single truth, beneath the sun.
                               Observe one twin, the other knows,
                               No faster signal, quantum flows.`,
                        clue: "Quirk Clue: Non-locality defines linked particles, hinting at cosmic connections."
                    },
                    {
                        name: "Uncertainty Quirk",
                        poem: `My pace or place, you cannot know,
                               Precise for one, the other won't show.
                               A fuzzy blur, where particles reside,
                               In quantum depths, my secrets hide.`,
                        clue: "Quirk Clue: Precision is fundamentally limited in the quantum realm for conjugate variables."
                    },
                    {
                        name: "Tunneling Quirk",
                        poem: `A barrier stands, a wall so grand,
                               Yet through its heart, I sometimes land.
                               No energy to leap, no path to trace,
                               Just quantum magic, defying space.`,
                        clue: "Quirk Clue: Particles can traverse energy barriers even without sufficient energy, a quantum shortcut."
                    }
                ],
                scientificFacts: [
                    "Fact: Fractal patterns, like those found in coastlines, snowflakes, and even broccoli, demonstrate self-similarity across different scales, often expressed through complex mathematics like the Mandelbrot Set.",
                    "Fact: The Fibonacci sequence (0, 1, 1, 2, 3, 5, 8...) appears ubiquitously in nature, from the spirals of a sunflower to the branching of trees, reflecting a fundamental mathematical order in growth.",
                    "Fact: The concept of 'dark matter' suggests that a significant portion of the universe's mass is invisible and does not interact with light, yet its gravitational effects are crucial for galaxy formation.",
                    "Fact: Quantum fluctuations in the vacuum of space, fleeting pairs of particles and antiparticles appearing and disappearing, are thought to be the origin of all matter and energy in the universe.",
                    "Fact: General Relativity describes gravity not as a force, but as a curvature of spacetime caused by mass and energy, dictating how objects move through this warped fabric.",
                    "Fact: The universe is expanding, and this expansion is accelerating, driven by a mysterious force called 'dark energy', which makes up about 68% of the universe's total energy density."
                ],
                endCreditStory: `
The Whisper of Creation:

A photon born during the earliest moments after the Big Bang
still travels through the cosmos today.
These ancient photons form what we now call
The Cosmic Microwave Background radiation,
enveloping us in a faint glow of universal history,
softly echoing the original story of existence itself.

When we look upon distant galaxies billions of light-years away,
we receive photons that began their journey long before Earth was formed.
We are literally looking into the past.
Yet, for those photons, no time has passed.
They embody a paradox that dissolves our ordinary concept of linearity,
inviting us into a deeper understanding of existence,
where past, present, and future coexist in an eternal now.
`
            }
        };

        // Game State Variables
        let gameState = {
            currentLocation: "",
            visitedLocations: new Set(), // Tracks locations the player has visited
            foundClues: new Set(), // Stores the text of clues already found
            solution: {}, // Stores the randomized solution { creator, method, origin }
            locationsData: {}, // A deep copy of gameConfig.locations with examinables and their clue status
            inEvent: false, // Flag to control event display flow
            messageBoxCallback: null // Callback for message box actions
        };

        // DOM Elements
        const gameOutput = document.getElementById('game-output');
        const commandInput = document.getElementById('command-input');
        const messageBoxOverlay = document.getElementById('message-box-overlay');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxContent = document.getElementById('message-box-content');
        const messageBoxButton = document.getElementById('message-box-button');


        /**
         * Displays text in the game output area and scrolls to the bottom.
         * @param {string} text - The text to display.
         */
        function displayOutput(text) {
            gameOutput.textContent += text + '\n';
            gameOutput.scrollTop = gameOutput.scrollHeight; // Scroll to bottom
        }

        /**
         * Shows a custom message box with a title, content, and optional button text/callback.
         * @param {string} title - The title of the message box.
         * @param {string} content - The content of the message.
         * @param {string} [buttonText='OK'] - The text for the button.
         * @param {function} [callback=null] - A function to execute when the button is clicked.
         */
        function showMessageBox(title, content, buttonText = 'OK', callback = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            messageBoxButton.textContent = buttonText;
            gameState.messageBoxCallback = callback; // Store the callback
            messageBoxOverlay.classList.add('visible');
            commandInput.blur(); // Remove focus from input while message box is open
        }

        /**
         * Hides the custom message box and refocuses the command input.
         * Executes the stored callback if it exists.
         */
        function hideMessageBox() {
            messageBoxOverlay.classList.remove('visible');
            commandInput.focus(); // Re-focus input after closing

            if (gameState.messageBoxCallback) {
                gameState.messageBoxCallback();
                gameState.messageBoxCallback = null; // Clear the callback
            }
        }

        /**
         * Initializes the game: sets up the solution and distributes clues.
         */
        function initGame() {
            // Reset game state
            gameState.visitedLocations.clear();
            gameState.foundClues.clear();
            gameState.inEvent = false;

            // 1. Determine the solution for this game
            gameState.solution = {
                creator: gameConfig.suspects[Math.floor(Math.random() * gameConfig.suspects.length)],
                method: gameConfig.weapons[Math.floor(Math.random() * gameConfig.weapons.length)],
                origin: gameConfig.origins[Math.floor(Math.random() * gameConfig.origins.length)]
            };

            // Deep copy locations data and initialize examinable clue status
            gameState.locationsData = {};
            const allClueEligibleExaminables = []; // To collect examinable items that *can* hold clues

            for (const locKey in gameConfig.locations) {
                const originalLoc = gameConfig.locations[locKey];
                gameState.locationsData[locKey] = {
                    description: originalLoc.description,
                    examinables: originalLoc.examinables.map(item => {
                        const newItem = { ...item, clueText: null, clueFound: false };
                        // Only add examinables that don't have a special action to the clue pool
                        if (!item.specialAction) {
                            allClueEligibleExaminables.push({ location: locKey, examinable: newItem });
                        }
                        return newItem;
                    })
                };
            }

            // 2. Prepare and distribute clues to examinable items
            const solutionParts = [
                { type: "creator", value: gameState.solution.creator },
                { type: "method", value: gameState.solution.method },
                { type: "origin", value: gameState.solution.origin }
            ];

            shuffleArray(allClueEligibleExaminables); // Shuffle all clue-eligible examinables to randomly assign clues

            // Assign one definite clue for each solution part to unique examinables
            for (let i = 0; i < solutionParts.length && i < allClueEligibleExaminables.length; i++) {
                const part = solutionParts[i];
                const targetExaminable = allClueEligibleExaminables[i].examinable;
                targetExaminable.clueText = `Observation: The ${part.type} was definitively linked to "${part.value}".`;
            }

            // Generate elimination clues for the remaining examinables
            const nonSolutionSuspects = gameConfig.suspects.filter(s => s !== gameState.solution.creator);
            const nonSolutionWeapons = gameConfig.weapons.filter(w => w !== gameState.solution.method);
            const nonSolutionOrigins = gameConfig.origins.filter(o => o !== gameState.solution.origin);

            let eliminationCluesPool = [];
            nonSolutionSuspects.forEach(s => eliminationCluesPool.push(`Analysis: The creator was NOT "${s}".`));
            nonSolutionWeapons.forEach(w => eliminationCluesPool.push(`Report: The method did NOT involve "${w}".`));
            nonSolutionOrigins.forEach(o => eliminationCluesPool.push(`Hypothesis: The origin was NOT "${o}".`));
            shuffleArray(eliminationCluesPool);

            // Assign remaining clues to remaining examinables
            for (let i = solutionParts.length; i < allClueEligibleExaminables.length; i++) {
                const targetExaminable = allClueEligibleExaminables[i].examinable;
                if (eliminationCluesPool.length > 0) {
                    targetExaminable.clueText = eliminationCluesPool.shift();
                } else {
                    targetExaminable.clueText = "The data here is inconclusive, a mere whisper in the cosmic background noise.";
                }
            }

            const allLocationKeys = Object.keys(gameState.locationsData);
            gameState.currentLocation = allLocationKeys[Math.floor(Math.random() * allLocationKeys.length)]; // Start at a random location
            gameOutput.textContent = ''; // Clear previous output
            displayOutput("////////////////////////////////////////////////////");
            displayOutput("// QUANTUM PARADOX: A REALITY UNRAVELS          //");
            displayOutput("//                                                //");
            displayOutput("// WELCOME, DETECTIVE. Reality is unraveling.     //");
            displayOutput("// Someone, using some quantum phenomenon, from   //");
            displayOutput("// some cosmic origin, created it. Your mission:  //");
            displayOutput("// uncover the truth.                             //");
            displayOutput("////////////////////////////////////////////////////\n");
            lookCommand(); // Display initial location
        }

        /**
         * Shuffles an array in place (Fisher-Yates algorithm).
         * @param {Array} array - The array to shuffle.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * Processes the player's command.
         * @param {string} command - The raw command string from the player.
         */
        async function processCommand(command) {
            // If an event is active, do not process normal commands
            if (gameState.inEvent) {
                displayOutput("SYSTEM: An active cosmic event is unfolding. Please wait...");
                return;
            }

            const parts = command.trim().toUpperCase().split(' ');
            const verb = parts[0];
            const args = parts.slice(1).join(' ');

            displayOutput(`> ${command}`); // Echo the command

            switch (verb) {
                case 'LOOK':
                    lookCommand();
                    break;
                case 'GO':
                    await goCommand(args); // Await goCommand as it has a delay
                    break;
                case 'EXAMINE':
                    examineCommand(args); // Pass arguments for which item to examine
                    break;
                case 'INVENTORY':
                    inventoryCommand();
                    break;
                case 'ACCUSE':
                    const accusationRegex = /ACCUSE (.+) WITH (.+) AT (.+)/;
                    const match = command.trim().toUpperCase().match(accusationRegex);
                    if (match && match.length === 4) {
                        const accusedCreator = match[1].trim();
                        const accusedMethod = match[2].trim();
                        const accusedOrigin = match[3].trim();
                        accuseCommand(accusedCreator, accusedMethod, accusedOrigin);
                    } else {
                        displayOutput("Syntax Error: ACCUSE command requires specific format. Try: ACCUSE [CREATOR] WITH [METHOD] AT [ORIGIN]");
                    }
                    break;
                case 'HELP':
                    helpCommand();
                    break;
                case 'RESTART':
                    initGame();
                    break;
                default:
                    displayOutput("Unknown command. Type 'HELP' for a list of commands.");
                    break;
            }
            commandInput.value = ''; // Clear input field

            // After each command, there's a chance for a random cosmic event
            const eventChance = 0.20; // 20% chance for an event
            if (Math.random() < eventChance && !gameState.inEvent) {
                gameState.inEvent = true; // Set flag to indicate an event is active
                displayOutput("\n<<< COSMIC ANOMALY DETECTED! >>>\n");
                // No await here, showMessageBox will handle the pause via callback
                const eventType = Math.random() < 0.5 ? 'gravity' : 'quirk'; // 50/50 for gravity/quirk
                if (eventType === 'gravity') {
                    triggerGravityEvent();
                } else {
                    triggerQuirkEvent();
                }
            }
        }

        /**
         * Triggers a random gravity-related event.
         */
        function triggerGravityEvent() {
            const gravityEvent = gameConfig.eventData.gravityEvents[Math.floor(Math.random() * gameConfig.eventData.gravityEvents.length)];
            let content = `--- ${gravityEvent.title} ---\n\n`;
            content += `${gravityEvent.description}\n`;
            if (gravityEvent.dialogue) {
                content += `\n${gravityEvent.dialogue}\n`;
            }
            content += `\nNew insight gained: "${gravityEvent.clue}"`;
            gameState.foundClues.add(gravityEvent.clue);

            showMessageBox("Cosmic Event!", content, "CONTINUE", () => {
                gameState.inEvent = false; // Reset flag after user clicks continue
                lookCommand(); // Refresh current location view after event
            });
        }

        /**
         * Triggers a random quantum quirk event.
         */
        function triggerQuirkEvent() {
            const quirkEvent = gameConfig.eventData.quirkEvents[Math.floor(Math.random() * gameConfig.eventData.quirkEvents.length)];
            let content = `--- ENCOUNTER: ${quirkEvent.name.toUpperCase()} ---\n\n`;
            content += `A manifestation of the ${quirkEvent.name} appears before you, offering a cryptic verse:\n\n`;
            content += `"${quirkEvent.poem}"\n\n`;
            content += `New insight gained: "${quirkEvent.clue}"`;
            gameState.foundClues.add(quirkEvent.clue);

            showMessageBox("Cosmic Event!", content, "CONTINUE", () => {
                gameState.inEvent = false; // Reset flag after user clicks continue
                lookCommand(); // Refresh current location view after event
            });
        }

        /**
         * Displays a simple text-based map, highlighting the current location.
         */
        function displayMap() {
            displayOutput("\n--- COSMIC MAP ---");
            const allLocationKeys = Object.keys(gameState.locationsData);
            allLocationKeys.forEach(loc => {
                if (loc === gameState.currentLocation) {
                    displayOutput(`[X] ${loc} <--- YOU ARE HERE`);
                } else {
                    displayOutput(`[ ] ${loc}`);
                }
            });
            displayOutput("------------------\n");
        }

        /**
         * Implements the 'LOOK' command: describes the current location, available exits, and examinable items.
         */
        function lookCommand() {
            const currentLocData = gameState.locationsData[gameState.currentLocation];
            if (!currentLocData) {
                displayOutput("Error: Current location data not found.");
                return;
            }

            displayOutput(`\n--- Current Location: ${gameState.currentLocation.toUpperCase()} ---`);
            displayOutput(currentLocData.description);

            // List examinable items
            if (currentLocData.examinables && currentLocData.examinables.length > 0) {
                displayOutput("\n--- Examinable Objects ---");
                currentLocData.examinables.forEach(item => {
                    let status = "";
                    if (item.specialAction && item.clueFound) { // clueFound for specialAction items means action performed
                        status = " (action performed)";
                    } else if (item.clueText && item.clueFound) {
                        status = " (clue found)";
                    } else if (item.clueText && !item.clueFound) {
                        status = " (clue awaiting)";
                    } else if (!item.clueText && !item.specialAction) {
                        status = " (no clue/action)";
                    }
                    displayOutput(`  - ${item.name.toUpperCase()}${status}`);
                });
                displayOutput("To examine, type: EXAMINE [OBJECT_NAME]");
            } else {
                displayOutput("There are no specific objects to examine here.");
            }

            const otherLocations = Object.keys(gameState.locationsData).filter(loc => loc !== gameState.currentLocation);
            displayOutput("\n--- Available Destinations ---");
            if (otherLocations.length > 0) {
                otherLocations.forEach(loc => displayOutput(`  - ${loc}`));
            } else {
                displayOutput("  No other accessible locations from here.");
            }
            displayOutput("------------------------------------\n");
            gameState.visitedLocations.add(gameState.currentLocation); // Mark as visited
            displayMap(); // Display the map after location description
        }

        /**
         * Displays a text-based transition graphic.
         */
        function displayTransitionGraphics() {
            const transitions = [
                "////////////////////////////////////////",
                "//  WARPING REALITY...                //",
                "//  (Data Streams Converging)         //",
                "////////////////////////////////////////",
                "--- QUANTUM JUMP IN PROGRESS ---",
                ".........",
                "--- TELEPORTATION COMPLETE ---",
                "...",
                "*** REALITY SHIFTS ***"
            ];
            const randomIndex = Math.floor(Math.random() * transitions.length);
            displayOutput(`\n${transitions[randomIndex]}\n`);
        }

        /**
         * Implements the 'GO' command: attempts to move to a new location.
         * @param {string} targetLocation - The name of the location to go to.
         */
        async function goCommand(targetLocation) {
            const normalizedTarget = Object.keys(gameState.locationsData).find(key =>
                key.toUpperCase() === targetLocation.toUpperCase()
            );

            if (normalizedTarget && normalizedTarget !== gameState.currentLocation) {
                displayOutput(`Moving to ${normalizedTarget}...`);
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay for initial message
                displayTransitionGraphics();
                // Increased delay here for a slower transition
                await new Promise(resolve => setTimeout(resolve, 2500)); // Delay for transition graphic
                gameState.currentLocation = normalizedTarget;
                lookCommand();
            } else if (normalizedTarget === gameState.currentLocation) {
                displayOutput(`You are already in ${gameState.currentLocation}.`);
            } else {
                displayOutput(`Unknown destination: "${targetLocation}". Check your cosmic map.`);
                displayOutput("Available destinations: " + Object.keys(gameState.locationsData).join(", "));
            }
        }

        /**
         * Special interaction for gazing through the telescope lens.
         */
        function gazeThroughLens() {
            displayOutput("\n--- GAZE THROUGH LENS ---");
            // Removed the problematic ASCII art block here
            displayOutput("As you peer into the lens, the cosmic canvas unfolds before you.");
            displayOutput("Nebulae swirl like vast, psychedelic clouds, pregnant with nascent stars. You witness the fiery birth of a stellar nursery, matter collapsing under gravity's relentless hand.");
            displayOutput("Further out, the ghostly remnants of a supernova bloom, an expanding sphere of energy where a star once blazed. The echoes of its death ripple through space-time, a powerful testament to the universe's cycle of creation and destruction.");
            displayOutput("Through the quantum fluctuations visible at the edge of the field, you catch a fleeting glimpse of something truly profound: a subtle ripple, like a disturbance in a primordial sea, hinting at the very fabric of reality being woven and unraveled.");
            displayOutput("You pull back from the eyepiece, your mind reeling with the vastness of it all. This observation may not be a direct clue, but it certainly offers a new perspective on the cosmic scale of the mystery.");
            displayOutput("-------------------------\n");
        }

        /**
         * Special interaction for interacting with the quantum computer.
         */
        function interactWithQuantumComputer() {
            displayOutput("\n--- INTERACTING WITH QUANTUM COMPUTER ---");
            displayOutput(`
   _______
  /       \\
 |  _.-._  |
 | ( o o ) |
 |  \`-'-'  |
  \\_______/
   |     |
   |=====|
   \`-----'`
            );
            displayOutput("The quantum computer whirs to life, its qubits flickering with impossible states. It runs a rapid simulation, displaying abstract data patterns.");
            displayOutput("Quantum computing harnesses principles like superposition (a qubit existing as 0 and 1 simultaneously) and entanglement (qubits being linked regardless of distance) to perform calculations far beyond classical computers.");
            displayOutput("The machine's algorithms manipulate these quantum states directly, exploring multiple possibilities at once. It hints at a reality where answers aren't singular, but a spectrum of probabilities. The raw processing power here could, theoretically, model the very origin of existence.");
            displayOutput("You sense the immense potential, and the inherent uncertainty, in such a device. This glimpse into its workings offers a new angle on how reality might be 'computed'.");
            displayOutput("-----------------------------------------\n");
        }

        /**
         * Special interaction for reading The Great Book of Knowledge.
         */
        function readGreatBook() {
            displayOutput("\n--- READING THE GREAT BOOK OF KNOWLEDGE ---");
            displayOutput(`
  .--.
 / _  \\
| (_) |
|  _  |
| (_) |
 \`--'
            `);
            const randomFact = gameConfig.eventData.scientificFacts[Math.floor(Math.random() * gameConfig.eventData.scientificFacts.length)];
            displayOutput(`As you open the ancient tome, its pages shimmer with primordial light. You focus on a passage:\n`);
            displayOutput(`"${randomFact}"`);
            displayOutput(`\nThe knowledge feels profound, adding another layer to your understanding of the universe's design.`);
            gameState.foundClues.add(`Insight from Great Book: ${randomFact}`);
            displayOutput("-----------------------------------------\n");
        }

        /**
         * Special interaction for interacting with Pop-Tart Kitty.
         */
        function interactWithPopTartKitty() {
            displayOutput("\n--- INTERACTING WITH POP-TART KITTY ---");
            displayOutput(`
     /\\_/\\
    ( o.o )
    > ^ <
   /  -  \\
  (_______)
   "POP!"
          "TART!"
                "MEOW!"`);
            displayOutput("Pop-Tart Kitty rubs against your leg, purring contentedly. As you gently stroke its shimmering fur, its form seems to ripple and resolve, as if constantly reorganizing itself. Its very existence appears to demonstrate the principles of fundamental biological coding.");
            displayOutput("DNA, the blueprint of life, is constantly undergoing processes of breakdown, where old or damaged segments are removed. Simultaneously, it replicates itself with astonishing fidelity to pass on genetic information, and regenerates to repair damage and maintain cellular function.");
            displayOutput("This continuous dance of deconstruction, duplication, and repair ensures the continuity and adaptability of all known life. It suggests a fundamental principle of self-organization and renewal, even at the most basic levels of reality's design.");
            gameState.foundClues.add("Insight from Pop-Tart Kitty: Reality may be continuously breaking down, replicating, and regenerating its fundamental information patterns.");
            displayOutput("---------------------------------------\n");
        }

        /**
         * Special interaction for riding the Black Hole Roller Coaster.
         */
        async function rideBlackHoleRollerCoaster() {
            displayOutput("\n--- RIDING THE BLACK HOLE ROLLER COASTER ---");
            displayOutput(`
      .--.
     /    \\
    |      |
    |      |
     \\    /
      \`--'
    _ _ _ _ _ _ _ _ _ _ _ _ _
   /                         \\
  |  [ ]-o-[ ]-o-[ ]-o-[ ]  |
  \\_ _ _ _ _ _ _ _ _ _ _ _ _/
            `);
            displayOutput("You strap into the conveyance. A low hum fills the air, and you're pulled into the swirling vortex of the black hole. Space and time distort around you, the very fabric of existence stretching and compressing.");
            displayOutput("In this impossible intersection, the universe reveals a profound truth: The classical world, governed by gravity and predictable trajectories, and the quantum realm, with its probabilities and uncertainties, are not separate. They are two faces of the same coin.");
            displayOutput("A 'Theory of Everything' aims to unite these seemingly disparate domains, suggesting that gravity itself might be quantized – transmitted by tiny, hypothetical particles. This ride offers a fleeting, intuitive grasp of how the dance of planets and the flicker of subatomic particles could be woven into one harmonious cosmic symphony.");
            displayOutput("With a jolt, you're ejected from the other side, reality snapping back into focus.\n");

            gameState.foundClues.add("Insight from Black Hole Ride: The universe hints at a singular theory that unites gravity and quantum forces, bridging the cosmic scale with the subatomic.");

            // Transport player to The Ancient Library
            displayOutput("You find yourself in a familiar, quiet place...");
            await new Promise(resolve => setTimeout(resolve, 2000)); // Delay before revealing new location
            gameState.currentLocation = "The Ancient Library";
            lookCommand(); // Describe the new location
            displayOutput("\n---------------------------------------\n");
        }


        /**
         * Implements the 'EXAMINE' command: reveals a clue from a specified item in the current location.
         * @param {string} itemName - The name of the item to examine.
         */
        function examineCommand(itemName) {
            const currentLocData = gameState.locationsData[gameState.currentLocation];
            if (!currentLocData || !currentLocData.examinables) {
                displayOutput("Error: Current location data or examinables not found.");
                return;
            }

            const targetExaminable = currentLocData.examinables.find(item =>
                item.name.toUpperCase() === itemName.toUpperCase()
            );

            if (!targetExaminable) {
                displayOutput(`You can't find "${itemName}" to examine here.`);
                displayOutput("Try: EXAMINE [OBJECT_NAME]");
                if (currentLocData.examinables.length > 0) {
                    displayOutput("Possible objects to examine: " + currentLocData.examinables.map(item => item.name).join(", "));
                }
                return;
            }

            // Display ASCII art if available
            if (targetExaminable.asciiArt) {
                displayOutput(`\n${targetExaminable.asciiArt}\n`);
            }

            // Handle special actions
            if (targetExaminable.specialAction) {
                if (!targetExaminable.clueFound) { // Use clueFound to track if special action has been performed
                    displayOutput(`\nYou interact with the ${targetExaminable.name.toUpperCase()}...`);
                    // Call the corresponding special action function
                    if (typeof window[targetExaminable.specialAction] === 'function') {
                        // Special actions like rideBlackHoleRollerCoaster might change location
                        // So we don't necessarily want to set clueFound until the action is complete
                        window[targetExaminable.specialAction]();
                        targetExaminable.clueFound = true; // Mark as action performed
                    } else {
                        displayOutput("Error: Special action not found for this object.");
                    }
                } else {
                    displayOutput(`You have already performed the special action with the ${targetExaminable.name}.`);
                }
                return; // Prevent standard clue logic for special action items
            }

            // Standard clue examination logic
            displayOutput(`\nYou EXAMINE the ${targetExaminable.name.toUpperCase()}...`);
            displayOutput(`  "${targetExaminable.description}"`);

            if (!targetExaminable.clueFound && targetExaminable.clueText) {
                displayOutput(`\n  You discover a fragment of cosmic data: "${targetExaminable.clueText}"`);
                gameState.foundClues.add(targetExaminable.clueText);
                targetExaminable.clueFound = true; // Mark this specific clue as found
            } else if (targetExaminable.clueFound) {
                displayOutput(`  You have already extracted all discernible information from the ${targetExaminable.name}.`);
            } else {
                // This branch would hit if clueText is null, meaning it was never assigned a clue
                displayOutput(`  No specific clue is found from the ${targetExaminable.name} at this time.`);
            }
            displayOutput("");
        }

        /**
         * Implements the 'INVENTORY' command: displays collected clues.
         */
        function inventoryCommand() {
            displayOutput("\n--- DETECTIVE'S NOTES (Collected Clues) ---");
            if (gameState.foundClues.size === 0) {
                displayOutput("  Your notes are empty. Perhaps you should 'EXAMINE' your surroundings.");
            } else {
                Array.from(gameState.foundClues).forEach((clue, index) => {
                    displayOutput(`  ${index + 1}. ${clue}`);
                });
            }
            displayOutput("-------------------------------------------\n");
            displayOutput("Possible Suspects: " + gameConfig.suspects.join(", "));
            displayOutput("Possible Methods: " + gameConfig.weapons.join(", "));
            displayOutput("Possible Origins: " + gameConfig.origins.join(", ") + "\n");
        }

        /**
         * Implements the 'ACCUSE' command: allows the player to guess the solution.
         * @param {string} accusedCreator - The player's guess for the creator.
         * @param {string} accusedMethod - The player's guess for the method.
         * @param {string} accusedOrigin - The player's guess for the origin.
         */
        function accuseCommand(accusedCreator, accusedMethod, accusedOrigin) {
            displayOutput(`\nYou prepare your accusation:`);
            displayOutput(`  Creator: ${accusedCreator}`);
            displayOutput(`  Method: ${accusedMethod}`);
            displayOutput(`  Origin: ${accusedOrigin}`);
            displayOutput(`Confirming your cosmic deduction...\n`);

            const isCreatorCorrect = accusedCreator.toUpperCase() === gameState.solution.creator.toUpperCase();
            const isMethodCorrect = accusedMethod.toUpperCase() === gameState.solution.method.toUpperCase();
            const isOriginCorrect = accusedOrigin.toUpperCase() === gameState.solution.origin.toUpperCase();

            if (isCreatorCorrect && isMethodCorrect && isOriginCorrect) {
                showMessageBox(
                    "ACCUSATION CONFIRMED!",
                    `You have successfully uncovered the truth! The reality was created by ${gameState.solution.creator}, using ${gameState.solution.method}, at ${gameState.solution.origin}. The fabric of existence is safe... for now. \n\n${gameConfig.eventData.endCreditStory}`,
                    "THE END"
                );
            } else {
                let feedback = "Your accusation is incorrect. ";
                if (!isCreatorCorrect) feedback += `The Creator was not "${accusedCreator}". `;
                if (!isMethodCorrect) feedback += `The Method was not "${accusedMethod}". `;
                if (!isOriginCorrect) feedback += `The Origin was not "${accusedOrigin}". `;
                feedback += "\n\nContinue your investigation, Detective.";
                showMessageBox("ACCUSATION DENIED!", feedback);
            }
        }

        /**
         * Implements the 'HELP' command: displays available commands and their usage.
         */
        function helpCommand() {
            displayOutput("\n--- AVAILABLE COMMANDS ---");
            displayOutput("  LOOK              : Describe your current location, examinable objects, and available destinations. Also shows the map.");
            displayOutput("  GO [DESTINATION]  : Travel to a new cosmic location (e.g., GO THE ANCIENT LIBRARY).");
            displayOutput("  EXAMINE [OBJECT]  : Investigate specific objects in your current location to find clues or special interactions (e.g., EXAMINE PODIUM, EXAMINE LENS, EXAMINE QUANTUM COMPUTER, EXAMINE HADRON COLLIDER, EXAMINE THE GREAT BOOK OF KNOWLEDGE, EXAMINE POP-TART KITTY, EXAMINE BLACK HOLE ROLLER COASTER).");
            displayOutput("  INVENTORY         : Review all the clues you have collected.");
            displayOutput("  ACCUSE [CREATOR] WITH [METHOD] AT [ORIGIN] : Make your final deduction.");
            displayOutput("                      Example: ACCUSE THE GRAND DESIGNER WITH QUANTUM ENTANGLEMENT AT THE ZERO-POINT FIELD");
            displayOutput("  HELP              : Display this list of commands.");
            displayOutput("  RESTART           : Begin a new game.");
            displayOutput("\n--- RANDOM COSMIC EVENTS ---");
            displayOutput("  Be aware: After some commands, a random cosmic event might occur, offering unique insights or clues!");
            displayOutput("---------------------------\n");
        }

        /**
         * Handles button clicks by translating them into command calls.
         * For 'GO' and 'ACCUSE', it hints at the need for further input.
         * @param {string} commandType - The type of command triggered by the button.
         */
        function handleButtonClick(commandType) {
            switch (commandType) {
                case 'look':
                    processCommand('LOOK');
                    break;
                case 'examine':
                    // Set input field value to "EXAMINE " and place cursor at the end
                    commandInput.value = 'EXAMINE ';
                    commandInput.focus();
                    commandInput.setSelectionRange(commandInput.value.length, commandInput.value.length);

                    const currentLocDataExamine = gameState.locationsData[gameState.currentLocation];
                    let examinableNames = [];
                    if (currentLocDataExamine && currentLocDataExamine.examinables) {
                        examinableNames = currentLocDataExamine.examinables.map(item => item.name.toUpperCase());
                    }
                    displayOutput(`\nType 'EXAMINE [OBJECT_NAME]' in the input field. E.g., EXAMINE ${examinableNames[0] || 'PODIUM'}.`);
                    if (examinableNames.length > 0) {
                        displayOutput("Possible objects to examine here: " + examinableNames.join(", ") + "\n");
                    }
                    break;
                case 'go':
                    // Set input field value to "GO " and place cursor at the end
                    commandInput.value = 'GO ';
                    commandInput.focus();
                    commandInput.setSelectionRange(commandInput.value.length, commandInput.value.length);

                    displayOutput("\nType 'GO [DESTINATION]' in the input field. E.g., GO THE QUANTUM LABORATORY.");
                    displayOutput("Available destinations: " + Object.keys(gameState.locationsData).join(", ") + "\n");
                    break;
                case 'inventory':
                    processCommand('INVENTORY');
                    break;
                case 'accuse':
                    displayOutput("\nType your full accusation in the input field. Format: ACCUSE [CREATOR] WITH [METHOD] AT [ORIGIN]");
                    displayOutput("Example: ACCUSE THE GRAND DESIGNER WITH QUANTUM ENTANGLEMENT AT THE ZERO-POINT FIELD\n");
                    displayOutput("Possible Suspects: " + gameConfig.suspects.join(", "));
                    displayOutput("Possible Methods: " + gameConfig.weapons.join(", ") + "\n");
                    displayOutput("Possible Origins: " + gameConfig.origins.join(", ") + "\n");
                    commandInput.focus();
                    break;
                case 'help':
                    processCommand('HELP');
                    break;
                case 'restart':
                    processCommand('RESTART');
                    break;
            }
        }

        // Event Listeners
        commandInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                processCommand(commandInput.value);
            }
        });

        // Initialize the game when the window loads
        window.onload = initGame;

        // Ensure command input is focused when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            commandInput.focus();
        });
    </script>
</body>
</html>
